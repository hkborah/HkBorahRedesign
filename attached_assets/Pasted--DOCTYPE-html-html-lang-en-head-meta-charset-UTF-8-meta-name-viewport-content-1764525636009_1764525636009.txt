<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HK Borah | AI Digital Twin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* FONTS:
           1. 'Playfair Display' (Serif) -> Used ONLY for the HK Logo.
           2. 'Inter' (Sans-Serif) -> Used for UI, Headings, and Body text for clarity.
        */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,700;1,700&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        
        /* Serif class strictly for the logo stamp */
        .font-serif-logo { font-family: 'Playfair Display', serif; }

        /* Ensure Inputs and Buttons use the clean font */
        input, button, textarea { font-family: 'Inter', sans-serif; }

        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-track { background: #f8fafc; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        
        /* Refined Typing Animation */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-transparent">

    <!-- Launcher -->
    <div id="chat-launcher" class="fixed bottom-6 right-6 z-50 cursor-pointer transition-all hover:scale-105 hover:shadow-xl" onclick="toggleChat()">
        <!-- Deep Navy (#1e293b) to match your site footer -->
        <div class="bg-[#1e293b] text-white p-4 rounded-full shadow-2xl flex items-center justify-center w-16 h-16 border border-slate-700">
            <i data-lucide="message-square" class="w-7 h-7"></i>
        </div>
    </div>

    <!-- Chat Window -->
    <div id="chat-window" class="fixed bottom-24 right-6 w-96 h-[600px] bg-white rounded-xl shadow-2xl z-50 flex flex-col hidden border border-slate-200 overflow-hidden font-sans ring-1 ring-slate-900/5">
        
        <!-- Header -->
        <div class="bg-[#1e293b] text-white p-5 flex justify-between items-center shadow-md">
            <div class="flex items-center gap-3">
                <!-- HK Logo: Kept Serif to match Book Cover Brand -->
                <div class="w-10 h-10 bg-white text-[#1e293b] rounded-full flex items-center justify-center overflow-hidden border-2 border-slate-400 font-serif-logo font-bold text-lg shadow-inner">
                    HK
                </div>
                <div>
                    <!-- CHANGED: Replaced 'THE BLUEPRINT' with 'HK Borah' -->
                    <h3 class="font-bold text-base tracking-wide font-sans">HK Borah</h3>
                    <p class="text-xs text-slate-300 uppercase tracking-wider text-[10px] font-sans">Digital Twin & Advisor</p>
                </div>
            </div>
            <div class="flex gap-1">
                <!-- Save Button -->
                <button onclick="saveChatToDrive()" class="hover:bg-slate-700 p-2 rounded-md text-slate-300 hover:text-white transition-colors" title="Download Chat">
                    <i data-lucide="save" class="w-5 h-5"></i>
                </button>
                <!-- Close Button -->
                <button onclick="toggleChat()" class="hover:bg-slate-700 p-2 rounded-md text-slate-300 hover:text-white transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- Messages Area -->
        <div id="messages" class="flex-1 bg-slate-50 p-5 overflow-y-auto chat-scroll flex flex-col gap-4">
            <div class="flex gap-3 items-start">
                <div class="w-8 h-8 bg-[#1e293b] rounded-full flex-shrink-0 flex items-center justify-center text-white text-xs font-serif-logo border border-slate-300 shadow-sm">HK</div>
                <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 border border-slate-200 leading-relaxed font-sans">
                    <span class="font-bold text-[#1e293b] block mb-1 font-sans text-base">Welcome.</span>
                    I am HK Borah's digital twin. <br><br>
                    I can help you validate ideas, fix broken processes, or scale your startup using the <em>Architectural Scaling Framework</em>. <br><br>
                    What challenge are you facing today?
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-white border-t border-slate-100">
            <form id="chat-form" onsubmit="sendMessage(event)" class="relative flex gap-2 items-center">
                <input type="text" id="user-input" placeholder="Ask about scaling, chaos, or strategy..." 
                    class="flex-1 pl-4 pr-12 py-3 bg-slate-100 border border-transparent rounded-full text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[#1e293b] focus:bg-white focus:border-transparent transition-all font-sans">
                
                <button type="submit" class="absolute right-2 top-2 bg-[#1e293b] text-white p-2 rounded-full hover:bg-[#0f172a] transition-colors disabled:opacity-50 shadow-sm" id="send-btn">
                    <i data-lucide="arrow-up" class="w-4 h-4"></i>
                </button>
            </form>
            <div class="text-center mt-3">
                <p class="text-[10px] text-slate-400 uppercase tracking-widest font-medium font-sans">Powered by HK Borah</p>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CHAT_API = "https://chatwithhk-6toeltovya-uc.a.run.app";
        const SAVE_API = "https://savechattohk-6toeltovya-uc.a.run.app";

        let chatHistory = [];
        lucide.createIcons();

        function toggleChat() {
            const window = document.getElementById('chat-window');
            window.classList.toggle('hidden');
            if (!window.classList.contains('hidden')) {
                setTimeout(() => document.getElementById('user-input').focus(), 100);
            }
        }

        async function sendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text) return;

            appendMessage('user', text);
            input.value = '';
            input.disabled = true;
            
            // Show loading
            const loadingId = showTypingIndicator();

            try {
                const response = await fetch(CHAT_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, history: chatHistory.slice(-6) })
                });
                
                const data = await response.json();
                removeTypingIndicator(loadingId);
                
                appendMessage('ai', data.reply);
                chatHistory.push({ role: "user", content: text });
                chatHistory.push({ role: "assistant", content: data.reply });

            } catch (error) {
                removeTypingIndicator(loadingId);
                appendMessage('ai', "I apologize, but I'm having trouble connecting to my knowledge base right now. Please try again in a moment.");
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        async function saveChatToDrive() {
            // Case 1: Empty Chat -> Show Alert
            if (chatHistory.length === 0) {
                alert("No chat history to save.");
                return;
            }

            const btn = document.querySelector('button[onclick="saveChatToDrive()"]');
            const originalIcon = btn.innerHTML;
            // Add a visual cue (spinner)
            btn.innerHTML = `<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>`;
            btn.disabled = true;

            // Prepare Content for User Download
            const textContent = chatHistory.map(msg => {
                const role = msg.role === 'user' ? 'FOUNDER' : 'HK BORAH';
                return `[${role}]:\n${msg.content}\n-------------------`;
            }).join('\n\n');

            try {
                // Case 2: Save to Server (Archival) - SILENTLY
                await fetch(SAVE_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ history: chatHistory })
                });
                // Success is silent.
            } catch (error) {
                console.error("Background archival failed:", error);
            } finally {
                // Case 3: Trigger Client-Side Download (User Action)
                const blob = new Blob([textContent], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `HK_Borah_Mentorship_${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                btn.innerHTML = originalIcon;
                btn.disabled = false;
                lucide.createIcons();
            }
        }

        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `flex gap-3 items-start ${role === 'user' ? 'flex-row-reverse' : ''}`;
            const bubbleClass = role === 'user' ? "bg-[#1e293b] text-white rounded-tr-none" : "bg-white text-slate-800 border border-slate-200 rounded-tl-none";
            const avatar = role === 'user' 
                ? `<div class="w-8 h-8 bg-slate-200 rounded-full flex-shrink-0 flex items-center justify-center text-slate-500 shadow-sm"><i data-lucide="user" class="w-4 h-4"></i></div>`
                : `<div class="w-8 h-8 bg-[#1e293b] rounded-full flex-shrink-0 flex items-center justify-center text-white text-xs font-serif-logo border border-slate-300 shadow-sm">HK</div>`;

            div.innerHTML = `
                ${avatar}
                <div class="${bubbleClass} p-3 rounded-2xl shadow-sm text-sm max-w-[80%] leading-relaxed font-sans">
                    ${text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}
                </div>
            `;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = 99999;
            lucide.createIcons();
        }

        function showTypingIndicator() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex gap-3 items-start";
            div.innerHTML = `
                <div class="w-8 h-8 bg-[#1e293b] rounded-full text-white flex items-center justify-center text-xs font-serif-logo border border-slate-300 shadow-sm">HK</div>
                <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-200 flex gap-1">
                    <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                </div>
            `;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = 99999;
            return id;
        }

        function removeTypingIndicator(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }
    </script>
</body>
</html>